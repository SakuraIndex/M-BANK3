name: Auto intraday & publish (5min, JST weekdays)

on:
  workflow_dispatch:
    inputs:
      force:
        description: "Force run even outside session?"
        required: false
        default: "false"
  schedule:
    - cron: "*/5 * * * 1-5"   # 平日5分

permissions:
  contents: write

concurrency:
  group: mbank3-intraday
  cancel-in-progress: true

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    env:
      FORCE: ${{ github.event.inputs.force == 'true' && '1' || '0' }}

    steps:
      - name: Checkout (this repo)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          set -euxo pipefail
          python -m pip install -U pip
          pip install -r requirements.txt

      - name: Compute JST session flags
        id: flags
        shell: python
        run: |
          from datetime import datetime, time
          from zoneinfo import ZoneInfo
          tz = ZoneInfo("Asia/Tokyo")
          now = datetime.now(tz)
          s, e = time(9,0), time(15,30)
          start = datetime.combine(now.date(), s, tzinfo=tz)
          end   = datetime.combine(now.date(), e, tzinfo=tz)
          in_session = start <= now <= end
          print(f"in_session={'true' if in_session else 'false'}")

      # === ここからは必ずビルド実行（セッション外でも実行）===
      - name: Build intraday (mbank3)
        run: |
          set -euxo pipefail
          python src/mbank3_intraday.py
          ls -la docs || true
          ls -la docs/outputs || true

      - name: Commit outputs (this repo)
        run: |
          set -euxo pipefail
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add docs/outputs/* || true
          git commit -m "chore(intraday): mbank3" || echo "no changes"
          git push || true

      # === SITE 連携（Secrets が両方ある時だけ実行）===
      - name: Decide site sync availability
        id: site
        run: |
          if [ -n "${{ secrets.SITE_REPO }}" ] && [ -n "${{ secrets.SITE_TOKEN }}" ]; then
            echo "enabled=true"  >> $GITHUB_OUTPUT
          else
            echo "enabled=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout SITE repo (optional)
        if: steps.site.outputs.enabled == 'true'
        uses: actions/checkout@v4
        with:
          repository: ${{ secrets.SITE_REPO }}
          path: site
          token: ${{ secrets.SITE_TOKEN }}

      - name: Render to SITE repo (legacy design) (optional)
        if: steps.site.outputs.enabled == 'true'
        run: |
          set -euxo pipefail
          python scripts/site_render_intraday.py
          python scripts/publish_to_site.py

      - name: Commit to SITE repo (optional)
        if: steps.site.outputs.enabled == 'true'
        working-directory: site
        run: |
          set -euxo pipefail
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add docs/charts/M_BANK3/* || true
          git commit -m "Update M-BANK3 intraday charts (JST)" || echo "no site changes"
          git push || true
