name: Auto intraday & publish (5min, JST weekdays)
runs-on: ubuntu-latest
timeout-minutes: 10
env:
FORCE: ${{ github.event.inputs.force == 'true' && '1' || '0' }}
steps:
- uses: actions/checkout@v4
with: { fetch-depth: 0 }


- name: Setup Python
uses: actions/setup-python@v5
with: { python-version: "3.11" }


- name: Install deps
run: |
python -m pip install -U pip
pip install -r requirements.txt


- name: Compute JST session flags
id: flags
shell: python
run: |
from datetime import datetime, time
from zoneinfo import ZoneInfo
tz = ZoneInfo("Asia/Tokyo")
now = datetime.now(tz)
s, e = time(9,0), time(15,30)
start = datetime.combine(now.date(), s, tzinfo=tz)
end = datetime.combine(now.date(), e, tzinfo=tz)
in_session = start <= now <= end
print(f"in_session={'true' if in_session else 'false'}")


- name: Build intraday (on-session or forced)
if: steps.flags.outputs.in_session == 'true' || env.FORCE == '1'
run: |
python src/mbank3_intraday.py


- name: Commit outputs (this repo)
if: steps.flags.outputs.in_session == 'true' || env.FORCE == '1'
run: |
git config user.name "github-actions[bot]"
git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
git add docs/outputs/* || true
git commit -m "chore(mbank3): intraday" || echo "no changes"
git push || true


- name: Checkout SITE repo (optional)
if: (steps.flags.outputs.in_session == 'true' || env.FORCE == '1') && secrets.SITE_REPO && secrets.SITE_TOKEN
uses: actions/checkout@v4
with:
repository: ${{ secrets.SITE_REPO }}
path: site
token: ${{ secrets.SITE_TOKEN }}


- name: Render (legacy design) into SITE repo
if: (steps.flags.outputs.in_session == 'true' || env.FORCE == '1') && secrets.SITE_REPO && secrets.SITE_TOKEN
run: |
python scripts/site_render_intraday.py


- name: Commit to SITE repo
if: (steps.flags.outputs.in_session == 'true' || env.FORCE == '1') && secrets.SITE_REPO && secrets.SITE_TOKEN
working-directory: site
run: |
git config user.name "github-actions[bot]"
git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
git add docs/charts/M_BANK3/* || true
git commit -m "Update M-BANK3 intraday charts (JST)" || echo "no site changes"
git push || true
